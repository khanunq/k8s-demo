pipeline {
  agent any

  parameters {
    choice(name: 'START_ACTIVE', choices: ['blue', 'green'], description: 'Color currently serving traffic')
    string(name: 'NEW_TAG', defaultValue: '${BUILD_NUMBER}', description: 'Image tag to build & deploy')
  }

  environment {
    REGISTRY    = 'docker.io'
    DOCKER_USER = 'zk0061'
    IMAGE       = "${env.REGISTRY}/${env.DOCKER_USER}/demo-web"
    // Always use Minikube's kubectl so we talk to the right cluster
    KUBECTL     = 'minikube kubectl --'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build & Tag') {
      steps {
        sh '''
          set -eux
          docker build -t ${IMAGE}:${NEW_TAG} .
          docker tag   ${IMAGE}:${NEW_TAG} ${IMAGE}:latest
        '''
      }
    }

    stage('Push') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DU', passwordVariable: 'DP')]) {
          sh '''
            set -eux
            echo "$DP" | docker login -u "$DU" --password-stdin ${REGISTRY}
            docker push ${IMAGE}:${NEW_TAG}
            docker push ${IMAGE}:latest
          '''
        }
      }
    }

    stage('Render Manifests') {
      steps {
        sh '''
          set -eux
          TAG=${NEW_TAG} DOCKER_USER=${DOCKER_USER} ./scripts/render.sh
        '''
      }
    }

    stage('Deploy to IDLE color') {
      steps {
        withCredentials([file(credentialsId: 'kubeconfig', variable: 'KCF')]) {
          withEnv(["KUBECONFIG=${KCF}"]) {
            script {
              def idle = (params.START_ACTIVE == 'blue') ? 'green' : 'blue'
              echo "Active is ${params.START_ACTIVE}; deploying to IDLE=${idle}"

              sh '''
                set -eux
                # Make sure Jenkins has a fresh API server URL/port
                minikube update-context

                # Create/ensure Service first (idempotent) — allow skipping validation
                ${KUBECTL} apply -f /tmp/service.yaml --validate=false
              '''

              if (idle == 'green') {
                sh '''
                  set -eux
                  ${KUBECTL} apply -f /tmp/deploy-green.yaml --validate=false
                  ${KUBECTL} rollout status deploy/demo-web-green --timeout=180s
                '''
              } else {
                sh '''
                  set -eux
                  ${KUBECTL} apply -f /tmp/deploy-blue.yaml --validate=false
                  ${KUBECTL} rollout status deploy/demo-web-blue --timeout=180s
                '''
              }

              script {
                currentBuild.description = "IDLE=${idle}, TAG=${params.NEW_TAG}"
              }
            }
          }
        }
      }
    }

    stage('Health check (IDLE)') {
      steps {
        withCredentials([file(credentialsId: 'kubeconfig', variable: 'KCF')]) {
          withEnv(["KUBECONFIG=${KCF}"]) {
            sh '''
              set -eux
              IDLE_SELECTOR=$([ "${START_ACTIVE}" = "blue" ] && echo "green" || echo "blue")
              ${KUBECTL} get pods -l app=demo-web,color=${IDLE_SELECTOR}
              ${KUBECTL} wait --for=condition=Ready pod -l app=demo-web,color=${IDLE_SELECTOR} --timeout=120s
            '''
          }
        }
      }
    }

    stage('Switch traffic') {
      steps {
        withCredentials([file(credentialsId: 'kubeconfig', variable: 'KCF')]) {
          withEnv(["KUBECONFIG=${KCF}"]) {
            sh '''
              set -eux
              if [ "${START_ACTIVE}" = "blue" ]; then TARGET="green"; else TARGET="blue"; fi

              # Update Service selector (correct JSON quoting + explicit merge)
              minikube kubectl -- patch svc demo-web-svc --type=merge \
                -p '{"spec":{"selector":{"app":"demo-web","color":"'"$TARGET"'"}}}'

              # Show where traffic goes now
              ${KUBECTL} get svc demo-web-svc -o jsonpath="{.spec.selector.color}"; echo
            '''
          }
        }
      }
    }
  }

  post {
    success {
      echo '✅ Blue/Green switch complete. Now serving the former IDLE color.'
    }
    failure {
      echo "❌ Failed before switch; traffic remains on START_ACTIVE=${params.START_ACTIVE}"
    }
  }
}
